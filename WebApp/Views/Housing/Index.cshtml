@using System.Web
@using Microsoft.AspNet.Http.Extensions
@using WebApp.ViewModels
@model WebApp.ViewModels.HousingIndexModel
@using Microsoft.AspNet.Authorization

@{
    ViewData["Title"] = "Index";
    @inject IAuthorizationService _auth;
}

@{
    bool userHasCreate = await _auth.AuthorizeAsync(User, AuthPolicy.CreateHousing);
    bool userHasEdit = await _auth.AuthorizeAsync(User, AuthPolicy.EditHousing);
    bool userHasDelete = await _auth.AuthorizeAsync(User, AuthPolicy.DeleteHousing);
}
    <h2>Список объектов</h2>

<p show-if="@userHasCreate">
    <a asp-action="Create" class="ui button blue">Добавить новый объект</a>
</p>

<form class="ui form segment" asp-action="Filter">
    <div class="three fields">
        @Html.EditorFor(x => x.Filters.HousingTypeList)
        @Html.EditorFor(x => x.Filters.City)
        @Html.EditorFor(x => x.Filters.District)
    </div>

    <div class="three fields">
        @Html.EditorFor(x => x.Filters.MinCost, "int")
        @Html.EditorFor(x => x.Filters.MaxCost, "int")
        @Html.EditorFor(x => x.Filters.SelectedObjectId, "int")
    </div>

    @Html.EditorFor(x => x.Filters.IsArchived, "checkbox")
    <input type="submit" value="Применить фильтр" class="ui primary button"/>
    <a asp-action="ResetFilter" class="ui button">Сброс</a>
</form>

<h4 class="ui horizontal divider header">
    <i class="tag icon"></i>
    Всего объектов в базе: @ViewBag.TotalItems Найдено: @ViewBag.FilteredItemsCount
</h4>

<pager total-pages="@Model.TotalPages" current-page='@Model.CurrentPage' link-url="@Context.Request.Path" query-params="@Context.Request.Query"></pager>

@foreach (var item in Model.Items)
{
    var archiveColorClass = item.IsArchived ? "secondary" : "";
    <div class="ui segment">
        @if (item.IsArchived) {
            <div class="ui top left attached red label">В архиве</div>
        } else {
            <div class="ui top left attached label">Актуальные</div>
        }
  
        <div class="ui stackable two column grid  @archiveColorClass">

            <div class="thirteen wide column">

                <div class="ui grid">
                    <div class="four wide column">
                        <h3><i class="home icon"></i>@Html.DisplayFor(x => item.HouseType)</h3>
                    </div>
                    <div class="four wide column">
                        <h3><i class="ruble icon"></i>@Html.DisplayFor(x => item.Cost)</h3>
                    </div>
                    <div class="four wide column">
                        <i class="marker icon"></i> @Html.DisplayFor(x => item.FullAddress)
                    </div>
                    <div class="four wide column">
                        @Html.DisplayFor(x => item.Phone1)&nbsp;&nbsp;&nbsp;@Html.DisplayFor(x => item.Phone2)&nbsp;&nbsp;&nbsp;@Html.DisplayFor(x => item.Phone3)
                    </div>
                    <div class="ten wide column">
                        <i class="write icon"></i> <span>@Html.DisplayFor(x => item.Comment)</span>
                    </div>
                </div>
            </div>
            <div class="two wide column right aligned">
                <div class="row column two">
                    <a onclick='@($"showModal('#item{item.EditId}');return false;")' class="ui button tiny">Подробности</a>
                    <div class="ui icon buttons">
                       
                            <a show-if="@userHasEdit" asp-action="Edit" asp-route-id="@item.EditId" class="ui circular icon button basic  blue" title="Редактирование"><i class="edit icon"></i></a>
                        
                        @if (item.IsArchived)
                        {
                            <a show-if="@userHasEdit" asp-action="FromArchive" asp-route-id="@item.EditId" class="ui button teal tiny basic" title="Из архива"><i class="archive icon"></i></a>
                        }
                        else
                        {
                            <a show-if="@userHasEdit" asp-action="ToArchive" asp-route-id="@item.EditId" class="ui button teal tiny basic" title="В архив"><i class="archive icon"></i></a>
                        }
                        <a asp-action="Delete" show-if="@userHasDelete" asp-route-id="@item.EditId" class="ui button red tiny basic" onclick="return confirm('Вы уверены что хотите удалить запись?');" title="Удалить"><i class="trash icon"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="ui modal" id='@($"item{item.EditId}")' item-id="@item.EditId">
          <i class="close icon"></i>
          <div class="header">
            @Html.DisplayFor(x => item.HouseType)
          </div>
          <div class="content">
            <div class="description">
             @Html.DisplayFor(x => item.Comment)
                <div class="ui form">
                  <div class="grouped fields">
                    <label>Результат прозвона</label>
                    <div class="field">
                      <div class="ui radio checkbox">
                        <input type="radio" name="callResult" checked="checked" value="Verified">
                        <label>Проверено</label>
                      </div>
                    </div>
                    <div class="field">
                      <div class="ui radio checkbox">
                        <input type="radio" name="callResult" value="DontAnswer">
                        <label>Не отвечает</label>
                      </div>
                    </div>
                    <div class="field">
                      <div class="ui radio checkbox">
                        <input type="radio" name="callResult" value="NotAvailable">
                        <label>Недоступен</label>
                      </div>
                    </div>
                    <div class="field">
                      <div class="ui radio checkbox">
                        <input type="radio" name="callResult" value="CorrectedWithoutCall">
                        <label>Корректировка без прозвона</label>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
          </div>
          <div class="actions">
            <div class="ui black deny button">
              Закрыть
            </div>
            <div class="ui positive right labeled icon button">
              Yep, that's me
              <i class="checkmark icon"></i>
            </div>
          </div>
        </div>
}

<pager total-pages="@Model.TotalPages" current-page='@Model.CurrentPage' link-url="@Context.Request.Path" query-params="@Context.Request.Query"></pager>

<script type="text/javascript">

    function showModal(id) {
    $(id).modal({
        closable: false,
        onDeny: function(){
                  window.alert('Wait not yet!');
                  return false;
                },
        onApprove: function() {
           
            var itemId = $(this).attr('item-id');

            $.ajax({
                type: "POST",
                url :'/Housing/AddCall',
                data: {
                      housingId: itemId,
                      status: $(this).find(':checked').val()
                  },

                 success: (response) => {
                      window.alert('success!');
                 },
                error: (response) => {
                    alert('error');
                }
           }
            );
        }
          }).modal('show');
    }
</script>